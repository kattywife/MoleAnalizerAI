# Product Requirements: AI Model for Skin Lesion Classification

## 1. Введение и Цель

**Название проекта:** Система ИИ для классификации кожных новообразований по фотографиям.

**Цель:** Разработать модель машинного обучения, способную анализировать дерматоскопические изображения кожных новообразований и метаданные пациента для предоставления вероятностной оценки различных типов кожных заболеваний, включая меланому, невус и базальноклеточную карциному. Модель предназначена для использования врачами-дерматологами и онкологами в качестве вспомогательного инструмента для диагностики.

**Конечный продукт (ИИ модель):** Модель, доступная через API, принимающая на вход изображение и метаданные, и возвращающая JSON с вероятностями принадлежности к каждому из предопределенных классов заболеваний.

## 2. Пользовательские Требования

*   Врач должен иметь возможность загрузить фотографию кожного новообразования.
*   Врач должен иметь возможность ввести релевантные метаданные пациента (возраст, пол, анатомическая локализация новообразования).
*   Система должна вернуть процентную вероятность для каждого из ключевых типов кожных заболеваний (например, Меланома, Невус, Базальноклеточная карцинома, и др. в зависимости от возможностей датасета).
*   Результаты должны быть представлены в понятном для врача формате.

## 3. Требования к Данным

### 3.1. Входные Данные для Модели
    *   **Изображение кожного новообразования:**
        *   Формат: JPEG, PNG.
        *   Качество: Дерматоскопическое изображение, достаточно четкое, с хорошим освещением и фокусом на новообразовании.
        *   Предварительная обработка: Модель должна включать шаги по стандартизации изображений (например, изменение размера до ожидаемого, нормализация значений пикселей).
    *   **Метаданные пациента:**
        *   `age_approx`: Возраст пациента (числовой, например, 50).
        *   `sex`: Пол пациента (категориальный: 'male', 'female', 'unknown').
        *   `anatom_site_general_challenge`: Анатомическое расположение новообразования (категориальный, например, 'torso', 'lower extremity', 'upper extremity', 'head/neck', 'palms/soles', 'oral/genital').

### 3.2. Выходные Данные Модели
    *   JSON объект, содержащий пары "название_болезни": "вероятность_в_процентах".
    *   Пример:
        ```json
        {
          "Меланома": 0.75, // 75%
          "Невус": 0.15,    // 15%
          "Базальноклеточная карцинома": 0.05, // 5%
          "Актинический кератоз": 0.03, // 3%
          "Доброкачественный кератоз": 0.02 // 2%
          // ... и другие релевантные классы из датасета ISIC
        }
        ```
    *   Сумма всех вероятностей должна быть равна 1.0 (или 100%).

### 3.3. Данные для Обучения
    *   **Источник:** The International Skin Imaging Collaboration (ISIC) Archive. Конкретно, данные из соревнований ISIC Challenge (например, ISIC 2019, ISIC 2020), которые содержат как изображения, так и метаданные.
    *   **Целевые классы:** Необходимо определить точный список классов на основе доступных в ISIC датасете и клинической значимости. Как минимум:
        *   Меланома (Melanoma - MEL)
        *   Меланоцитарный невус (Nevus - NV)
        *   Базальноклеточная карцинома (Basal cell carcinoma - BCC)
        *   Актинический кератоз / Болезнь Боуэна (Actinic keratosis / Bowen's disease - AKIEC)
        *   Доброкачественный кератоз (лихеноидный кератоз, себорейный кератоз, солнечное лентиго - Benign keratosis-like lesions - BKL)
        *   Дерматофиброма (Dermatofibroma - DF)
        *   Сосудистые поражения (Vascular lesions - VASC)
    *   **Разделение данных:** Стандартное разделение на обучающую, валидационную и тестовую выборки (например, 70%/15%/15%). Обеспечить стратификацию по классам при разделении.
    *   **Аугментация данных:** Применять стандартные техники аугментации изображений для увеличения разнообразия обучающей выборки и повышения робастности модели (например, повороты, отражения, изменение масштаба, сдвиги, изменение яркости/контрастности).

## 4. Требования к ИИ Модели

### 4.1. Архитектура Модели
    *   **Тип:** Сверточная Нейронная Сеть (CNN).
    *   **Transfer Learning:** Использовать предобученную на ImageNet CNN в качестве основы (feature extractor). Рекомендуемые архитектуры:
        *   EfficientNet (B0-B7)
        *   ResNet (ResNet50, ResNet101)
        *   InceptionV3 / InceptionResNetV2
        *   DenseNet
    *   **Дообучение (Fine-tuning):**
        *   Начальный этап: Заморозить все слои предобученной модели, кроме классификационного блока. Обучить только новые добавленные слои (fully-connected layers для классификации и, возможно, для интеграции метаданных).
        *   Последующий этап: "Разморозить" несколько последних сверточных блоков (или все слои) предобученной модели и продолжить обучение с низким learning rate для тонкой подстройки весов под специфику задачи.
    *   **Интеграция метаданных:**
        *   Метаданные (возраст, пол, локализация) должны быть предварительно обработаны (например, one-hot encoding для категориальных, нормализация для числовых).
        *   Обработанные метаданные конкатенируются с выходом сверточного блока (flattened features) перед подачей в полносвязные слои классификатора.

### 4.2. Программная Реализация
    *   **Фреймворк:** TensorFlow (с использованием Keras API).
    *   **Язык программирования:** Python 3.x.

### 4.3. Обучение
    *   **Оптимизатор:** Adam, AdamW, RMSprop.
    *   **Функция потерь:** Categorical Crossentropy (для мультиклассовой классификации).
    *   **Метрики для мониторинга обучения:** Accuracy, Precision (per class), Recall (per class), F1-score (per class), AUC (per class и macro/micro average).
    *   **Регуляризация:** Dropout, L1/L2 регуляризация (при необходимости, для борьбы с переобучением).
    *   **Early Stopping:** Использовать для предотвращения переобучения, отслеживая метрику на валидационной выборке (например, `val_loss` или `val_auc`).

### 4.4. Оценка Качества Модели
    *   **Основные метрики (на тестовой выборке):**
        *   Общая точность (Accuracy).
        *   Precision, Recall, F1-score для каждого класса (особенно важны для редких, но критичных классов, как меланома).
        *   Area Under the ROC Curve (AUC-ROC) для каждого класса и усредненный.
        *   Матрица ошибок (Confusion Matrix) для визуализации ошибок классификации между классами.
    *   **Специфичные метрики (если применимо):**
        *   Чувствительность (Sensitivity = Recall) для класса "Меланома".
        *   Специфичность (Specificity) для класса "Меланома".

## 5. Среда Разработки и Развертывания

### 5.1. Среда Разработки
    *   **Платформа:** Google Colaboratory (Colab) для экспериментов и начальной разработки.
    *   **Основные библиотеки:** `tensorflow`, `keras`, `pandas`, `numpy`, `scikit-learn`, `matplotlib`, `seaborn`, `opencv-python` (для обработки изображений).

### 5.2. Развертывание (в виде API)
    *   Модель должна быть сохранена в формате, пригодном для загрузки и использования (например, TensorFlow SavedModel или HDF5).
    *   API должно быть реализовано на Python (например, с использованием Flask или FastAPI).
    *   API принимает на вход изображение (например, base64 строка или multipart/form-data) и JSON с метаданными.
    *   API возвращает JSON с вероятностями классов (см. п. 3.2).

## 6. Ограничения и Предположения

*   Модель является инструментом поддержки принятия решений, а не заменой профессиональной медицинской диагностики.
*   Качество входных изображений критически влияет на точность предсказаний.
*   Данные ISIC, хотя и обширны, могут иметь свои смещения (bias), которые могут отразиться на модели.
*   Модель должна быть протестирована на разнообразных данных, чтобы оценить её обобщающую способность.
*   Необходимо учитывать этические аспекты и возможные ошибки модели, особенно при диагностике критических состояний.

## 7. Будущие Улучшения (Необязательно для MVP)

*   Реализация методов объяснимости ИИ (XAI), например, Grad-CAM, для визуализации областей изображения, которые повлияли на решение модели.
*   Возможность обработки видеопотока с дерматоскопа.
*   Интеграция с системами электронных медицинских карт (EMR/EHR).
*   Механизмы непрерывного обучения и дообучения модели на новых данных.
*   Расширение списка распознаваемых заболеваний.