# Product Requirements Document: Сервер API для анализа изображений родинок

**Версия документа:** 1.0
**Дата создания:** 2023-10-27
**Автор:** (Ваше имя/Команда)

## 1. Введение

### 1.1. Цель продукта
Цель данного продукта — предоставить серверное API, которое принимает изображение родинки и связанные с ним метаданные пациента, обрабатывает их с помощью обученной модели машинного обучения и возвращает вероятностную оценку различных кожных заболеваний (например, меланома, невус, базальноклеточная карцинома и т.д.). API предназначено для интеграции с desktop-приложением для дерматологов и онкологов, выступая в качестве инструмента поддержки принятия врачебных решений.

**Важно:** Данный API и модель не являются средством постановки окончательного диагноза и должны использоваться квалифицированными медицинскими специалистами как вспомогательный инструмент.

### 1.2. Обзор
Сервер будет реализован на Python с использованием веб-фреймворка (например, FastAPI или Flask). Он будет предоставлять HTTP-эндпоинт, на который desktop-приложение сможет отправлять запросы с изображением и метаданными. После обработки запроса моделью, API вернет JSON-ответ с распределением вероятностей по известным классам заболеваний.

## 2. Целевые пользователи

*   **Первичные:** Desktop-приложение для врачей-дерматологов и онкологов (которое будет взаимодействовать с этим API).
*   **Вторичные:** Разработчики и сопровождающие системы (для интеграции, тестирования и обслуживания API).

## 3. Функциональные требования (FR)

### FR1: Прием изображения родинки
*   Система должна принимать изображение родинки в одном из распространенных форматов (JPEG, PNG).
*   Изображение должно передаваться как часть `multipart/form-data` запроса.
*   Должна быть возможность ограничить максимальный размер принимаемого файла (например, 10MB) для предотвращения злоупотреблений и обеспечения производительности.

### FR2: Прием метаданных
*   Система должна принимать структурированные метаданные о пациенте и образовании в формате JSON.
*   Метаданные передаются как отдельная часть `multipart/form-data` запроса или как часть JSON-тела, если изображение передается, например, в base64 (предпочтительнее `multipart/form-data` для файлов).
*   Обязательные метаданные:
    *   `age` (возраст пациента, целое число)
    *   `sex` (пол пациента, строка, например, "Male", "Female", "Other")
    *   `location` (анатомическое расположение родинки, строка, например, "Trunk", "Head/Neck", "Extremities", "Palms/Soles", "Oral/Genital")
*   Опциональные метаданные могут быть добавлены в будущем.

### FR3: Валидация входных данных
*   Система должна проверять наличие изображения и его соответствие поддерживаемым форматам.
*   Система должна проверять наличие обязательных метаданных и их соответствие ожидаемым типам и форматам (например, возраст > 0, пол из списка допустимых значений).
*   В случае некорректных данных, система должна возвращать ошибку с информативным сообщением и соответствующим HTTP-статусом (например, 400 Bad Request).

### FR4: Предобработка данных для модели
*   Система должна выполнять предобработку изображения (изменение размера, нормализация и т.д.) в соответствии с требованиями используемой ML-модели.
*   Система должна выполнять предобработку метаданных (например, кодирование категориальных признаков), если это необходимо для модели.

### FR5: Загрузка и использование ML-модели
*   Система должна загружать предварительно обученную ML-модель при запуске сервера (или по первому запросу с кэшированием).
*   Система должна передавать предобработанные данные (изображение и метаданные) на вход модели для получения предсказания.

### FR6: Формирование и возврат результата
*   Система должна возвращать результат предсказания в формате JSON.
*   Ответ должен содержать словарь, где ключи — это названия классов заболеваний (например, "Меланома", "Невус"), а значения — соответствующие вероятности (числа от 0 до 1).
*   Сумма всех вероятностей в ответе должна быть равна 1 (с учетом возможных погрешностей округления).
*   В случае успешной обработки запроса, система должна возвращать HTTP-статус 200 OK.

### FR7: Обработка ошибок модели
*   В случае внутренней ошибки при работе модели или обработке данных, система должна возвращать ошибку с информативным сообщением и соответствующим HTTP-статусом (например, 500 Internal Server Error).

## 4. Нефункциональные требования (NFR)

### NFR1: Производительность
*   Среднее время ответа на запрос (от получения до отправки ответа) не должно превышать 2 секунды для 95% запросов при типичной нагрузке (P95 < 2s).
*   Система должна быть способна обрабатывать как минимум N одновременных запросов (N будет определено на этапе тестирования нагрузки, например, 5-10 для начала).

### NFR2: Масштабируемость
*   Архитектура должна позволять горизонтальное масштабирование путем запуска нескольких экземпляров сервера за балансировщиком нагрузки. (Первоначально может быть один экземпляр).

### NFR3: Надежность и доступность
*   Сервер должен быть доступен 99.9% времени (без учета планового обслуживания).
*   Сервер должен корректно обрабатывать ошибки и не падать при получении некорректных данных или при пиковых нагрузках (в рамках разумного).

### NFR4: Безопасность
*   Для передачи данных между клиентом (desktop-приложением) и сервером рекомендуется использовать HTTPS.
*   Входные данные должны валидироваться для предотвращения базовых атак (например, слишком большие файлы).
*   (Опционально для v1, если API не публичное) Рассмотреть базовую аутентификацию (например, API-ключ), если сервер будет доступен извне защищенной сети.

### NFR5: Удобство обслуживания и развертывания
*   Код должен быть документирован.
*   Процесс развертывания должен быть максимально автоматизирован (например, с использованием Docker).
*   Система должна вести логи запросов, ответов и ошибок.

### NFR6: Логирование
*   Система должна логировать все входящие запросы (без чувствительных данных пациента, если это критично, или с маскированием).
*   Система должна логировать основные этапы обработки запроса.
*   Система должна логировать все ошибки и исключения с достаточным контекстом для отладки.
*   Уровни логирования (DEBUG, INFO, WARNING, ERROR) должны использоваться корректно.

## 5. Формат данных API

### 5.1. Эндпоинт для предсказания
*   **URL:** `/predict`
*   **Метод:** `POST`
*   **Тип контента запроса:** `multipart/form-data`

### 5.2. Тело запроса (`multipart/form-data`)
*   **Поле 1:**
    *   **Имя:** `image_file`
    *   **Тип:** Файл (image/jpeg, image/png)
    *   **Описание:** Изображение родинки.
*   **Поле 2:**
    *   **Имя:** `metadata`
    *   **Тип:** Строка (JSON)
    *   **Описание:** JSON-строка с метаданными.
    *   **Пример JSON:**
        ```json
        {
          "age": 55,
          "sex": "Male",
          "location": "Trunk"
        }
        ```

### 5.3. Тело успешного ответа (HTTP 200 OK)
*   **Тип контента:** `application/json`
*   **Пример JSON:**
    ```json
    {
      "predictions": {
        "Melanoma": 0.153,
        "Nevus": 0.701,
        "Basal cell carcinoma": 0.105,
        "Actinic keratosis": 0.021,
        "Benign keratosis-like lesions": 0.010,
        "Dermatofibroma": 0.005,
        "Vascular lesions": 0.005
      },
      "model_version": "1.0.2" // Опционально, версия используемой модели
    }
    ```
    *Примечание: Названия классов должны соответствовать тем, что использовались при обучении модели и понятны врачу.*

### 5.4. Тело ответа с ошибкой (HTTP 4xx, 5xx)
*   **Тип контента:** `application/json`
*   **Пример JSON (для 400 Bad Request):**
    ```json
    {
      "error": {
        "code": "INVALID_INPUT",
        "message": "Age must be a positive integer.",
        "details": {
            "field": "age",
            "value_provided": -5
        }
      }
    }
    ```
*   **Пример JSON (для 500 Internal Server Error):**
    ```json
    {
      "error": {
        "code": "INTERNAL_SERVER_ERROR",
        "message": "An unexpected error occurred while processing the request. Please try again later."
      }
    }
    ```

## 6. Предположения и ограничения
*   Модель машинного обучения уже обучена и доступна в виде файла (например, `.h5`, `.pt`, или формат `SavedModel`).
*   Инфраструктура для развертывания Python-приложения (сервер, Docker-окружение) будет предоставлена или настроена отдельно.
*   Первоначальная версия API не будет включать механизмы пользовательской аутентификации или авторизации, предполагая использование в защищенной среде или с другими механизмами контроля доступа на уровне сети.

## 7. Вне рамок текущей версии (Future Considerations)
*   Аутентификация и авторизация пользователей/клиентов API.
*   Механизмы Rate Limiting.
*   Эндпоинт для пакетной обработки изображений.
*   Эндпоинт для получения информации о версии модели или доступных моделях.
*   Возможность обратной связи от врачей для дообучения модели (потребует значительного расширения функционала).
*   Интеграция с системами мониторинга (например, Prometheus, Grafana).
*   Возврат интерпретируемых результатов (например, карты внимания Grad-CAM).

## 8. Технологический стек (Предполагаемый)
*   **Язык программирования:** Python 3.8+
*   **Веб-фреймворк:** FastAPI (предпочтительно) или Flask
*   **Библиотеки для ML:** TensorFlow/Keras, PyTorch (в зависимости от модели)
*   **Обработка изображений:** Pillow, OpenCV
*   **Сервер ASGI/WSGI:** Uvicorn (для FastAPI), Gunicorn (для Flask)
*   **Контейнеризация:** Docker (настоятельно рекомендуется)